## Gateway


curl localhost:8080/actuator/gateway/routes -s | jq '.[] | {"\(.route_id)": "\(.route_definition.predicates[0].args._genkey_0)"}'

docker-compose logs -f --tail=0 gateway

curl localhost:8080/product-composite/2

curl -H "accept:application/json" localhost:8080/eureka/api/apps -s | jq -r .applications.application[].instance[].instanceId

http://localhost:8080/eureka/web

curl http://localhost:8080/headerrouting -H "Host: i.feel.lucky:8080"
curl http://localhost:8080/headerrouting -H "Host: im.a.teapot:8080"
curl http://localhost:8080/headerrouting

sudo bash -c "echo '127.0.0.1 i.feel.lucky im.a.teapot' >> /etc/hosts"

curl http://i.feel.lucky:8080/headerrouting
curl http://im.a.teapot:8080/headerrouting

docker-compose down

## security

(option) keytool -genkeypair -alias localhost -keyalg RSA -keysize 2048 -storetype PKCS12 -keystore edge-test.p12 -validity 3650
enter: password
enter: testtest

docker-compose up -d --scale gateway=0
docker-compose up -d --scale gateway=1

ACCESS_TOKEN=$(curl k https://writer:secret@$HOST:$PORT/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq .access_token -r)

./gradlew build && docker-compose build
./test-all.sh start

curl -k https://writer:secret@localhost:8443/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq .
curl -k https://reader:secret@localhost:8443/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq .

ACCESS_TOKEN=

https://localhost:8443/oauth/authorize?response_type=token&client_id=reader&redirect_uri=http://my.redirect.uri&scope=product:read&state=48532
https://localhost:8443/oauth/authorize?response_type=token&client_id=writer&redirect_uri=http://my.redirect.uri&scope=product:read+product:write&state=95372
enter: magnus/password

http://my.redirect.uri/#access_token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTI4NjcsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiIxMjkwNTMwOC01MmJiLTQzYzAtYWMzMS03OTZhMzA4M2YyYWYiLCJjbGllbnRfaWQiOiJyZWFkZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiXX0.TbFzyzjCeo_-TZyaBJejJI3GCGbdMwvzD-1Mtgj91asIU4sO4xUVpIxkrPWxMaWzURBYeVCVCy4_R3KMUwc1d95jUQDA6dsdzWYb8ngnoPxcPT2pWfyi_WCwbjPbt7lSEL-li9Lr9XPk4-YG7cxZX07rxQWngUHEEOtJTktJPO0RE_df2UL7Sbel2PV_arQcC4EWJZwbYvvYBwCFVG_ZiTPYC0vlEnJk02OMR_5KMRtdWHYDRogHAmi8oujUbeoJTjyXmm6-dTX5i2-5owUzBr20rzH5wqDeTyphSWwRvUSqp7-Y1gHBC5fnDTJc8C87v5Y6ECRUIoUXS80TtbrVQA&token_type=bearer&state=48532&expires_in=599999999&jti=12905308-52bb-43c0-ac31-796a3083f2af
http://my.redirect.uri/#access_token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTMxMDMsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiJmYWQ4OTRjNi1hMWEwLTQ4YWItODYwNi1kMzZmNDVlMzdmNGIiLCJjbGllbnRfaWQiOiJ3cml0ZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiLCJwcm9kdWN0OndyaXRlIl19.K5D0YPpsJ8VirinTs4ljgY5TSygKN3muCpUlTQx9_DKx0muhKOCkAx_Ut0ShSw-9NZd9_vKUOYO5GHVc63LO8zeOCXc5QhaYTz1AKRQvVgQ7UlJdbBgxREoDx3Kz7-cyRPoyF2tqsFiYBkyWxfC959wrZeVZJ5WT3GDRIf2cEWSZ3R0AIhmDvq3VwbXxTgR-Un3iTwtfRFdcxcn9s_dThDfbqCrcIWlyoydDv_Vd1OAaQc5hfVmzDvpgr_EUQYF9o54tJ3TWmy9YxETeYNy0K7xd8WOO_lqHKQg-vKGLKQPAQlnRgMdnRMAMCxaV26YCPkE8jCDh9q57491gCCOvCQ&token_type=bearer&state=95372&expires_in=599999999&jti=fad894c6-a1a0-48ab-8606-d36f45e37f4b

https://localhost:8443/oauth/authorize?response_type=code&client_id=reader&redirect_uri=http://my.redirect.uri&scope=product:read&state=35725

http://my.redirect.uri/?code=LKidCV&state=35725
CODE=LKidCV

curl -k https://reader:secret@localhost:8443/oauth/token \
-d grant_type=authorization_code \
-d client_id=reader \
-d redirect_uri=http://my.redirect.uri \
-d code=$CODE -s | jq .

[reader]
ACCESS_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTM1NTYsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiI2ZTA2NGNkMS1lYmVhLTRhYTYtOWE5OC0wZGQxODA1ZjU4NWEiLCJjbGllbnRfaWQiOiJyZWFkZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiXX0.OyB1ZmTcKp5WK1YLIjbbDipf4lFkuww3mdDbs5hVvhuOSIbv_ALQ1gD6ehSvlwNh6JZQ5pJubqTDhMR-OTj24_kpVnFEJGkOabPQfLowWdK0ZeT55Ar-_JdF8s9TNhL2SVH8QE1HVD7DqHcQIz9z8Obn6omMiTSX8cJRMrtK6RNKUOgMPvRBVZ_2GthbJCgMpm_tgfzM2ki9iKWGolWCh8VNEKaU_yzkgu7kc5B_GgJCLQUW5QqKO61cma3IVDdcrB24B2KYxdeRyl1s7LhiRrTSawVP3HWQVYaL_xJ2F1hUTmPr5Rwq_AcMAWJUsu7mQRrDGRBQDCLPcS9mIArUlw

https://localhost:8443/oauth/authorize?response_type=code&client_id=writer&redirect_uri=http://my.redirect.uri&scope=product:read+product:write&state=72489

ACCESS_TOKEN=an-invalid-token
curl https://localhost:8443/product-composite/2 -k -H "Authorization: Bearer $ACCESS_TOKEN" -i
[reader]
ACCESS_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTM1NTYsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiI2ZTA2NGNkMS1lYmVhLTRhYTYtOWE5OC0wZGQxODA1ZjU4NWEiLCJjbGllbnRfaWQiOiJyZWFkZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiXX0.OyB1ZmTcKp5WK1YLIjbbDipf4lFkuww3mdDbs5hVvhuOSIbv_ALQ1gD6ehSvlwNh6JZQ5pJubqTDhMR-OTj24_kpVnFEJGkOabPQfLowWdK0ZeT55Ar-_JdF8s9TNhL2SVH8QE1HVD7DqHcQIz9z8Obn6omMiTSX8cJRMrtK6RNKUOgMPvRBVZ_2GthbJCgMpm_tgfzM2ki9iKWGolWCh8VNEKaU_yzkgu7kc5B_GgJCLQUW5QqKO61cma3IVDdcrB24B2KYxdeRyl1s7LhiRrTSawVP3HWQVYaL_xJ2F1hUTmPr5Rwq_AcMAWJUsu7mQRrDGRBQDCLPcS9mIArUlw
curl https://localhost:8443/product-composite/999 -k -H "Authorization: Bearer $ACCESS_TOKEN" -X DELETE -i

http://my.redirect.uri/?code=OMS69I&state=72489
CODE=OMS69I

curl -k https://writer:secret@localhost:8443/oauth/token \
-d grant_type=authorization_code \
-d client_id=writer \
-d redirect_uri=http://my.redirect.uri \
-d code=$CODE -s | jq .

[writer]
ACCESS_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTQzNTcsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiJlMDNhZDRmMS04YjM5LTQ0ZWQtODIxMC0xZTg0MjdjMjE0NTUiLCJjbGllbnRfaWQiOiJ3cml0ZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiLCJwcm9kdWN0OndyaXRlIl19.AhHLhRG8xWUUB8NYB4Kuv8AcgEj-rqLPnTMsdMeQRudelkQn9Wd-mOVdz9zrRGfMEf9xS97aw6Tnwq0BHnKeQ-8jCfj4FJaynPsJnkarHm_mQRnPAO3f9pN6p4IMFbZ9xEE4ToW-qDTXXduYldANz7bEvYwccnGrkRP1eJTT0O9HE2HHlAd26IrwpBWLGlDeuooNouHJ-irKotQ_1qcnv5PL0-XqGwGMLiTaiASe6vRR7qk2afSt5sVuMa8Tz0nuxE_4BYtvfhlbh_-lx6ZDjwbTjyEEk3B-CczRw-nPEG4ugjkJsNoUQ-MpCxvrqvfXJej6vr8ifYH2eK_qoo3H5Q
curl https://localhost:8443/product-composite/999 -k -H "Authorization: Bearer $ACCESS_TOKEN" -X DELETE -i

docker-compose logs -f product-composite

docker-compose down

tenant domain: dev-vb7vi3nb.auth0.com
Client ID: BXaLl0UmUl04p761JCKJ0bcEEm87oYMs
Client Secret: AjtUm6_r0cys0IJr6lb3mxAXQhbrvgjPyXqu3rZBW3EayKNHiWbWlXAkodtFngZ4

curl https://dev-vb7vi3nb.auth0.com/.well-known/openid-configuration -s | jq

./gradlew build && docker-compose up -d --build product-composite gateway

./test-all.sh start
docker-compose logs -f product-composite

curl --request POST \
  --url 'https://dev-vb7vi3nb.auth0.com/oauth/token' \
  --header 'content-type: application/json' \
  --data '{"grant_type":"password", "username":"yuchiung10@yahoo.com.tw", "password":"Genekuo123", "audience":"https://localhost:8443/product-composite", "scope":"openid email product:read product:write", "client_id": "BXaLl0UmUl04p761JCKJ0bcEEm87oYMs", "client_secret": "AjtUm6_r0cys0IJr6lb3mxAXQhbrvgjPyXqu3rZBW3EayKNHiWbWlXAkodtFngZ4"}' -s | jq

curl --request POST \
  --url 'https://dev-vb7vi3nb.auth0.com/oauth/token' \
  --header 'content-type: application/json' \
  --data '{"grant_type":"password", "username":"yuchiung10@yahoo.com.tw", "password":"Genekuo123", "audience":"https://localhost:8443/product-composite", "scope":"openid email product:read", "client_id": "BXaLl0UmUl04p761JCKJ0bcEEm87oYMs", "client_secret": "AjtUm6_r0cys0IJr6lb3mxAXQhbrvgjPyXqu3rZBW3EayKNHiWbWlXAkodtFngZ4"}' -s | jq

https://dev-vb7vi3nb.auth0.com/authorize?response_type=token&scope=openid email product:read product:write&client_id=BXaLl0UmUl04p761JCKJ0bcEEm87oYMs&state=98421&&nonce=jxdlsjfi0fa&redirect_uri=http://my.redirect.uri&audience=https://localhost:8443/product-composite
https://dev-vb7vi3nb.auth0.com/authorize?response_type=token&scope=openid email product:read&client_id=BXaLl0UmUl04p761JCKJ0bcEEm87oYMs&state=98421&&nonce=jxdlsjfi0fa&redirect_uri=http://my.redirect.uri&audience=https://localhost:8443/product-composite

https://dev-vb7vi3nb.auth0.com/authorize?audience=https://localhost:8443/product-composite&scope=openid email product:read product:write&response_type=code&client_id=BXaLl0UmUl04p761JCKJ0bcEEm87oYMs&redirect_uri=http://my.redirect.uri&state=845361
[Get]
http://my.redirect.uri/?code=CO1YGh7D6qeRi0YI&state=845361

curl --request POST \
  --url 'https://dev-vb7vi3nb.auth0.com/oauth/token' \
  --header 'content-type: application/json' \
  --data '{"grant_type":"authorization_code", "client_id": "BXaLl0UmUl04p761JCKJ0bcEEm87oYMs", "client_secret": "AjtUm6_r0cys0IJr6lb3mxAXQhbrvgjPyXqu3rZBW3EayKNHiWbWlXAkodtFngZ4", "code": "CO1YGh7D6qeRi0YI", "redirect_uri": "http://my.redirect.uri"}' -s | jq

ACCESS_TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik1qYzVOVEpGUVRBM056aERSa1E1UVRVelFUQTFRMEpDTnpBeFJqQkVNVUl6UmtVNFFqQTNSZyJ9.eyJpc3MiOiJodHRwczovL2Rldi12Yjd2aTNuYi5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NWUwNDljODM2MDhjMWEwZTc3YjZiMzMyIiwiYXVkIjpbImh0dHBzOi8vbG9jYWxob3N0Ojg0NDMvcHJvZHVjdC1jb21wb3NpdGUiLCJodHRwczovL2Rldi12Yjd2aTNuYi5hdXRoMC5jb20vdXNlcmluZm8iXSwiaWF0IjoxNTc3Mzc5ODMxLCJleHAiOjE1Nzc0NjYyMzEsImF6cCI6IkJYYUxsMFVtVWwwNHA3NjFKQ0tKMGJjRUVtODdvWU1zIiwic2NvcGUiOiJvcGVuaWQgZW1haWwgcHJvZHVjdDpyZWFkIHByb2R1Y3Q6d3JpdGUifQ.UeUmZT3zy70QV48Hr3svc05_XAHcMyiXZwwbuNq2ZalSVzhJ5Dujkjc1vmDXUdw4VGCVSsr3aktPsFcKCBZ5M3DuJhFfIZx3Zkr8zwVpDY_cbqMMnbfPD0D-eZGtKqML1636Z0Lo_VK6Zc4qs5LkELDXUGHnCAsbV4GCCIjo8t0QFB-XVxB_l9RdvqeSjJSI0YE3KN5n5kYUCd8Tk3HQPkVF7emypJD2aC24byVjVHTAsHO5nbHu-QL8EWB9Fz2HinFoQ2-ui6-nrQcdksP1TXXRBe03lu7V8bR_VmhiEE7N46Qv0u_gXOp2uDU4Jx0TsXPYriEg-DX9m48dt4kYTw
curl https://localhost:8443/product-composite/2 -k -H "Authorization: Bearer $ACCESS_TOKEN" -i

ACCESS_TOKEN=
curl https://localhost:8443/product-composite/999 -k -H "Authorization: Bearer $ACCESS_TOKEN" -X DELETE -i

curl -H "Authorization: Bearer $ACCESS_TOKEN" https://dev-vb7vi3nb.auth0.com/userinfo -s | jq

docker-compose down

note: for OpenID Connect,
1. in product-composite-service and gateway, modify application.yml, then rebuild services:
spring.security.oauth2.resourceserver.jwt.issuer-uri: https://dev-vb7vi3nb.auth0.com/
2. in test-all.sh
ACCESS_TOKEN=$(curl --request POST --url 'https://dev-vb7vi3nb.auth0.com/oauth/token' --header 'content-type: application/json' --data '{"grant_type":"password", "username":"yuchiung10@yahoo.com.tw", "password":"Genekuo123", "audience":"https://localhost:8443/product-composite", "scope":"openid email product:read product:write", "client_id": "BXaLl0UmUl04p761JCKJ0bcEEm87oYMs", "client_secret": "AjtUm6_r0cys0IJr6lb3mxAXQhbrvgjPyXqu3rZBW3EayKNHiWbWlXAkodtFngZ4"}' -s | jq -r .access_token)
READER_ACCESS_TOKEN=$(curl --request POST --url 'https://dev-vb7vi3nb.auth0.com/oauth/token' --header 'content-type: application/json' --data '{"grant_type":"password", "username":"yuchiung10@yahoo.com.tw", "password":"Genekuo123", "audience":"https://localhost:8443/product-composite", "scope":"openid email product:read", "client_id": "BXaLl0UmUl04p761JCKJ0bcEEm87oYMs", "client_secret": "AjtUm6_r0cys0IJr6lb3mxAXQhbrvgjPyXqu3rZBW3EayKNHiWbWlXAkodtFngZ4"}' -s | jq -r .access_token)

## config
./gradlew build && docker-compose build
./test-all.sh start

curl https://dev-usr:dev-pwd@localhost:8443/config/product/docker -ks | jq .

curl -k https://dev-usr:dev-pwd@localhost:8443/config/encrypt --data-urlencode "hello world"

curl -k https://dev-usr:dev-pwd@localhost:8443/config/decrypt -d 42018a02aa61db174e9ac0c00f28b80912ba1e581d0b86793ebb08356bcb104d

## Resilience
./gradlew build && docker-compose build
./test-all.sh start

unset ACCESS_TOKEN
ACCESS_TOKEN=$(curl -k https://writer:secret@localhost:8443/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq -r .access_token)
echo $ACCESS_TOKEN

curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/health -qO - | jq -r .details.productCircuitBreaker.details.state

curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2?delay=3 -s | jq .
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2?delay=3 -s | jq .
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2?delay=3 -s | jq .
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2?delay=3 -s | jq .

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/health -qO - | jq -r .details.productCircuitBreaker.details.state

curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/health -qO - | jq -r .details.productCircuitBreaker.details.state

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/circuitbreakerevents/product/STATE_TRANSITION -qO - | jq -r '.circuitBreakerEvents[-3].stateTransition, .circuitBreakerEvents[-2].stateTransition, .circuitBreakerEvents[-1].stateTransition'

[run a couple of times]
time curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2?faultPercent=25 -w "%{http_code}\n" -o /dev/null -s

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/retryevents -qO - | jq '.retryEvents[-2], .retryEvents[-1]'
