./gradlew build && docker-compose build
./test-all.sh start

unset ACCESS_TOKEN
ACCESS_TOKEN=$(curl -k https://writer:secret@localhost:8443/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq -r .access_token)
echo $ACCESS_TOKEN

curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s

[Verify circuit breaker CLOSED]
docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/health -qO - | jq -r .details.productCircuitBreaker.details.state

[Force Circuit Breaker to open]
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k 'https://localhost:8443/product-composite/2?delay=3' -s | jq .
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k 'https://localhost:8443/product-composite/2?delay=3' -s | jq .
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k 'https://localhost:8443/product-composite/2?delay=3' -s | jq .
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k 'https://localhost:8443/product-composite/2?delay=3' -s | jq .

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/health -qO - | jq -r .details.productCircuitBreaker.details.state

[Close Circuit Breaker again]
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s
curl -H "Authorization: Bearer $ACCESS_TOKEN" -k https://localhost:8443/product-composite/2 -w "%{http_code}\n" -o /dev/null -s

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/health -qO - | jq -r .details.productCircuitBreaker.details.state

[List last State Transitions]
docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/circuitbreakerevents/product/STATE_TRANSITION -qO - | jq -r '.circuitBreakerEvents[-3].stateTransition, .circuitBreakerEvents[-2].stateTransition, .circuitBreakerEvents[-1].stateTransition'

[Retries]
[run a couple of times]
time curl -H "Authorization: Bearer $ACCESS_TOKEN" -k 'https://localhost:8443/product-composite/2?faultPercent=25' -w "%{http_code}\n" -o /dev/null -s

docker run --rm -it --network=my-network alpine wget product-composite:8080/actuator/retryevents -qO - | jq '.retryEvents[-2], .retryEvents[-1]'

docker-compose down

[clean up]
docker stop $(docker ps -a -q)
docker rm $(docker ps -a -q)
docker rmi $(docker images -a -q)
